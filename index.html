<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Reparaciones</title>
    <link rel="stylesheet" href="estilos.css">
    
</head>
<body>
    
    <div class="container_principal">
        <div class="container_registro">
            <h3>Registro de Reparaciones</h3>
            <form id="repairForm">
                <label for="name">Nombre del Cliente</label>
                <input type="text" id="name" name="name" required>

                <label for="phone">Teléfono del Cliente</label>
                <input type="tel" id="phone" name="phone" required>

                <label for="reference">Referencia del Aparato</label>
                <input type="text" id="reference" name="reference" required>

                <label for="details">Detalles de la Reparación</label>
                <textarea id="details" name="details" rows="4" required></textarea>

                <label for="price">Precio del Arreglo</label>
                <input type="number" id="price" name="price" required>

                <label for="deposit">Abono</label>
                <input type="number" id="deposit" name="deposit" required>

                <label for="status">Estado</label>
                <select id="status" name="status" required>
                    <option value="Completado">Completado</option>
                    <option value="No Reparado">No Reparado</option>
                    <option value="Revisando">Revisando</option>
                    <option value="Pendiente Repuesto">Pendiente Repuesto</option>
                </select>

                <label for="entryDate">Fecha de Ingreso</label>
                <input type="date" id="entryDate" name="entryDate" required>

                <label for="deliveryDate">Fecha de Entrega</label>
                <input type="date" id="deliveryDate" name="deliveryDate">

                <button type="submit">Registrar</button>
            </form>
        </div>
        
        <div class="container_listado" id="repairList">
                <script>
                document.getElementById('repairForm').addEventListener('submit', async function(e) {  /* registramos las reparaciones */
                    e.preventDefault();

                    const data = {
                        name: document.getElementById('name').value,
                        phone: document.getElementById('phone').value,
                        reference: document.getElementById('reference').value,
                        details: document.getElementById('details').value,
                        price: document.getElementById('price').value,
                        deposit: document.getElementById('deposit').value,
                        status: document.getElementById('status').value,
                        entryDate: document.getElementById('entryDate').value,
                        deliveryDate: document.getElementById('deliveryDate').value
                    };

                    try {
                        const response = await fetch('http://localhost:3000/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            alert('Registro exitoso');
                            document.getElementById('repairForm').reset();
                            loadRepairs();
                        } else {
                            alert('Error en el registro');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error en la solicitud');
                    }
                });
                async function loadRepairs() {   /* cargamos las reparaciones */
                    try {
                        const response = await fetch('http://localhost:3000/repairs');
                        const repairs = await response.json();
                        const repairList = document.getElementById('repairList');

                        repairList.innerHTML = '<h3>Reparaciones Registradas</h3>'; // Reset list

                        repairs.forEach(repair => {
                            const repairItem = document.createElement('div');
                            repairItem.className = 'repair-item';

                            repairItem.innerHTML = `
                                <p><strong>Nombre:</strong> ${repair.name}</p>
                                <p><strong>Teléfono:</strong> ${repair.phone}</p>
                                <p><strong>Referencia:</strong> ${repair.reference}</p>
                                <div id='leer_mas${repair.id}'>
                                    <a href='#' onclick='document.getElementById("contenido${repair.id}").style.display = "block"; document.getElementById("leer_mas${repair.id}").style.display = "none";'>Leer más ${repair.id}</a>
                                </div>
                                <div id='contenido${repair.id}' style="display: none;">
                                    <a href='#' onclick='document.getElementById("contenido${repair.id}").style.display = "none"; document.getElementById("leer_mas${repair.id}").style.display = "block";'>Leer menos${repair.id}</a>
                                <p><strong>Detalles:</strong> ${repair.details}</p>
                                <p><strong>Precio:</strong> ${repair.price}</p>
                                <p><strong>Abono:</strong> ${repair.deposit}</p>
                                <p><strong>Estado:</strong> ${repair.status}</p>
                                <p><strong>Fecha de Ingreso:</strong> ${repair.entry_date}</p>
                                <p><strong>Fecha de Entrega:</strong> ${repair.delivery_date || 'N/A'}</p>
                                <button class="status-pending" onclick="updateStatus(${repair.id}, 'Pendiente Repuesto')">Pendiente Repuesto</button>
                                <button class="status-in-process" onclick="updateStatus(${repair.id}, 'En Proceso')">En Proceso</button>
                                <button class="status-ok" onclick="updateStatus(${repair.id}, 'Completado')">Completado</button>
                                <button class="status-no-repair" onclick="updateStatus(${repair.id}, 'No Reparado')">No Reparado</button>
                                </div>
                            `;

                            repairList.appendChild(repairItem);
                        });
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al obtener los datos');
                    }
                }
                async function updateStatus(id, status) {     /*actualizamos el estado */
                    try {
                        const response = await fetch(`http://localhost:3000/update-status/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status })
                        });

                        if (response.ok) {
                            alert('Estado actualizado');
                            loadRepairs();
                        } else {
                            alert('Error al actualizar el estado');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error en la solicitud');
                    }
                }
                async function filterRepairs() {  // funcion para filtrar las reparaciones //
                    const status = document.getElementById('filterStatus').value;
                    const url = status ? `http://localhost:3000/repairs/status/${status}` : 'http://localhost:3000/repairs';

                    try {
                        const response = await fetch(url);
                        const repairs = await response.json();
                        displayRepairs(repairs);
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al filtrar los datos');
                    }
                }

                function displayRepairs(repairs) {
                    const repairList = document.getElementById('repairList');
                    repairList.innerHTML = `
                        <h1>Reparaciones Registradas</h1>
                        <label for="filterStatus">Filtrar por estado</label>
                        <select id="filterStatus" onchange="filterRepairs()">
                            <option value="">Todos</option>
                            <option value="Completado">Completado</option>
                            <option value="No Reparado">No Reparado</option>
                            <option value="Revisando">Revisando</option>
                            <option value="Pendiente Repuesto">Pendiente Repuesto</option>
                        </select>
                    `;

                    repairs.forEach(repair => {
                        const repairItem = document.createElement('div');
                        repairItem.className = 'repair-item';

                        repairItem.innerHTML = `
                            <h2>${repair.name}</h2>
                            <p><strong>Teléfono:</strong> ${repair.phone}</p>
                            <p><strong>Referencia:</strong> ${repair.reference}</p>
                            <p><strong>Detalles:</strong> ${repair.details}</p>
                            <p><strong>Precio:</strong> ${repair.price}</p>
                            <p><strong>Abono:</strong> ${repair.deposit}</p>
                            <p><strong>Estado:</strong> ${repair.status}</p>
                            <p><strong>Fecha de Ingreso:</strong> ${repair.entry_date}</p>
                            <p><strong>Fecha de Entrega:</strong> ${repair.delivery_date || 'N/A'}</p>
                            <button class="update-status status-pending" onclick="updateStatus(${repair.id}, 'Pendiente Repuesto')">Pendiente Repuesto</button>
                            <button class="update-status status-in-process" onclick="updateStatus(${repair.id}, 'En Proceso')">En Proceso</button>
                            <button class="update-status" onclick="updateStatus(${repair.id}, 'Completado')">Completado</button>
                        `;

                        repairList.appendChild(repairItem);
                    });
                }
                
                

                window.onload = loadRepairs;
            </script>
        </div>
    </div>
</body>
</html>
